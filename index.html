<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Chess</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
</head>

<body>
    <!-- Main Menu -->
    <div id="mainMenu" class="menu-overlay">
        <div class="menu-content">
            <h1>Chess Game</h1>
            <button id="createRoomBtn" class="menu-btn">Create Room</button>
            <button id="joinRoomBtn" class="menu-btn">Join Room</button>
            <button id="playComputerBtn" class="menu-btn">Play vs Computer</button>
            <button id="importPgnBtn" class="menu-btn" style="background-color: #4b8b3b;">Game Review</button>
        </div>
    </div>

    <!-- PGN Import Modal -->
    <div id="pgnModal" class="menu-overlay" style="display: none;">
        <div class="menu-content">
            <h2>Import Game</h2>
            <p style="color:#aaa; font-size:14px; margin-bottom:10px;">Paste PGN from Chess.com or Lichess</p>
            <textarea id="pgnInput" class="pgn-textarea" placeholder="[Event ...] ... 1. e4 e5 ..."></textarea>
            <div class="code-actions">
                <button id="loadPgnBtn" class="menu-btn">Analyze Game</button>
                <button id="cancelPgnBtn" class="secondary-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Color Selection Modal (Used for Create Room too) -->
    <div id="colorModal" class="menu-overlay" style="display: none;">
        <div class="menu-content">
            <h2>Select Side</h2>

            <div id="engineLevelContainer" class="engine-settings">
                <div class="elo-header">
                    <span class="elo-label">Maximum</span>
                    <span id="eloDisplay" class="elo-value">3200</span>
                </div>
                <input type="range" id="eloInput" min="400" max="3200" value="3200" step="100" class="elo-slider">
            </div>
            <div class="btn-group">
                <button id="playWhiteBtn" class="menu-btn">Play as White</button>
                <button id="playBlackBtn" class="menu-btn">Play as Black</button>
            </div>
            <button id="backBtn" class="secondary-btn">Back</button>
        </div>
    </div>

    <!-- Join Room Modal -->
    <div id="joinModal" class="menu-overlay" style="display: none;">
        <div class="menu-content">
            <h2>Join Room</h2>
            <input type="text" id="roomCodeInput" class="room-input" placeholder="Enter 6-digit Code" maxlength="6">
            <button id="confirmJoinBtn" class="menu-btn">Join Game</button>
            <button id="joinBackBtn" class="secondary-btn">Back</button>
        </div>
    </div>

    <!-- Waiting Modal -->
    <div id="waitingModal" class="menu-overlay" style="display: none;">
        <div class="menu-content">
            <h2>Room Created</h2>
            <p>Share this code with your friend:</p>
            <div id="displayRoomCode" class="code-display">---</div>
            <p class="pulse-text">Waiting for opponent...</p>
            <button id="cancelRoomBtn" class="secondary-btn">Cancel</button>
        </div>
    </div>

    <!-- Game Over Modal -->
    <div id="gameOverModal" class="menu-overlay" style="display: none;">
        <div class="menu-content">
            <h2 id="gameOverTitle">Game Over</h2>
            <p id="gameOverMessage">White won by checkmate.</p>
            <button id="modalReviewBtn" class="menu-btn" style="background-color: #81b64c; margin-top: 15px;">Review
                Game</button>
        </div>
    </div>

    <!-- Disconnect Modal -->
    <div id="disconnectModal" class="menu-overlay" style="display: none;">
        <div class="menu-content">
            <h2>Opponent Disconnected</h2>
            <p>The other player has left the game.</p>
            <button id="disconnectMenuBtn" class="menu-btn">Main Menu</button>
        </div>
    </div>

    <div id="gameArea" class="game-container" style="display: none;">
        <div class="game-main-area">
            <!-- Evaluation Bar -->
            <div id="evalBarContainer" class="eval-bar-container" style="display: none;">
                <div class="eval-bar-wrapper">
                    <div id="evalBarBlack" class="eval-fill-black"></div>
                    <div id="evalBarWhite" class="eval-fill-white"></div>
                </div>
                <!-- Score is usually floating or inside -->
                <div id="evalScore" class="eval-score">0.0</div>
            </div>

            <!-- Central Board Area -->
            <div class="board-area">
                <div class="status-bar">
                    <span id="status">White's Turn</span>
                </div>

                <!-- Opponent Info -->
                <div class="player-info" id="topPlayer">
                    <span class="player-label">Opponent</span>
                    <div class="captured-pieces" id="topCaptured"></div>
                    <div class="score" id="topScore"></div>
                </div>
                <!-- Game Area -->
                <div class="game-area">

                    <!-- Coach Overlay (Absolute or Relative) -->
                    <div id="coachContainer" class="coach-container" style="display: none;">
                        <div class="coach-avatar">
                            <img src="./chess_coach_avatar.png" alt="Coach">
                        </div>
                        <div class="speech-bubble">
                            <div class="bubble-header">
                                <span id="coachTitle" class="coach-title">Coach</span>
                                <span id="coachEval" class="coach-eval-badge">+0.5</span>
                            </div>
                            <p id="coachMessage">Welcome back! Let's analyze your game.</p>
                        </div>
                    </div>

                    <div class="board-container" style="position:relative;">
                        <div id="board" class="board"></div>
                        <svg id="arrowLayer" class="arrow-layer" width="100%" height="100%"
                            style="position:absolute; top:0; left:0; pointer-events:none; z-index: 100;"></svg>
                    </div>
                </div>

                <!-- My Info -->
                <div class="player-info" id="bottomPlayer">
                    <span class="player-label">You</span>
                    <div class="captured-pieces" id="bottomCaptured"></div>
                    <div class="score" id="bottomScore"></div>
                </div>
                <div class="controls">
                    <button id="prevBtn" style="font-weight:900;">&lt;</button>
                    <button id="nextBtn" style="font-weight:900;">&gt;</button>
                    <button id="resetBtn">New Game</button>
                    <button id="flipBtn">Flip Board</button>
                    <button id="menuBtn">Main Menu</button>
                    <button id="gameReviewBtn" class="review-btn" style="display: none;">Review Game</button>
                </div>
            </div>

            <!-- Review Panel -->
            <div id="reviewPanel" class="review-panel" style="display: none;">
                <div class="review-header">
                    <h3>Game Review</h3>
                    <button id="closeReviewBtn" class="close-btn">&times;</button>
                </div>

                <!-- Tabs -->
                <div class="review-tabs">
                    <button id="tabSummary" class="tab-btn active">Report</button>
                    <button id="tabMoves" class="tab-btn">Moves</button>
                </div>

                <!-- Summary View -->
                <div id="viewSummary" class="review-view" style="display: flex;">
                    <div class="summary-accuracy">
                        <div class="acc-card white-card">
                            <span class="acc-title">Accuracy</span>
                            <span id="sumWhiteAcc" class="acc-big">--</span>
                        </div>
                        <div class="acc-card black-card">
                            <span id="sumBlackAcc" class="acc-big">--</span>
                        </div>
                    </div>

                    <div id="statsTable" class="stats-table">
                        <!-- Filled by JS -->
                    </div>
                </div>

                <!-- Moves View (Originally Move List) -->
                <div id="viewMoves" class="review-view" style="display: none;">
                    <div class="accuracy-container">
                        <!-- Kept for consistency if needed, but summary has better one -->
                        <div style="padding:10px; font-size:12px; color:#aaa; text-align:center;">
                            Click on moves to analyze.
                        </div>
                    </div>
                    <div id="moveList" class="move-list">
                        <!-- Moves will be injected here -->
                    </div>
                </div>
            </div>

            <!-- Mobile Review Controls (Only shown in Review Mode via CSS/JS) -->
            <div id="mobileReviewControls" class="review-navigation" style="display: none;">
                <button class="review-nav-btn" onclick="reviewNav('prev')"><i
                        class="fas fa-chevron-left">&lt;</i></button>
                <button class="review-main-btn" onclick="reviewNav('next')">Next</button>
                <button class="review-nav-btn" onclick="reviewNav('retry')"><i class="fas fa-undo"></i></button>
            </div>
        </div>
    </div>

    <!-- Stockfish from CDN (using a reliable version if available, or a fallback) -->
    <!-- Note: stockfish.js often requires a worker file. We will try to configure it in JS. -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.0/stockfish.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="script.js"></script>
</body>

</html>